<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ¨ AI CSS Generator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: radial-gradient(circle at 20% 20%, #1a1c2c, #0c0c12 80%);
      font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
      color: #eaeaea;
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }

    /* ì¢Œì¸¡ ë¯¸ë¦¬ë³´ê¸° */
    #preview {
      flex: 1;
      background: #fff;
      border: none;
      margin: 20px;
      border-radius: 16px;
      box-shadow: 0 0 30px rgba(97, 218, 251, 0.25);
      transition: box-shadow 0.3s ease;
    }
    #preview:hover {
      box-shadow: 0 0 45px rgba(97, 218, 251, 0.4);
    }

    /* ìš°ì¸¡ ì±„íŒ… íŒ¨ë„ */
    .chat-panel {
      flex: 0.5;
      max-width: 600px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(14px);
      margin: 20px 20px 20px 0;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 20px rgba(97, 218, 251, 0.15);
      border: 1px solid rgba(97, 218, 251, 0.1);
    }

    header {
      text-align: center;
      padding: 20px 10px 10px;
    }

    header h1 {
      font-size: 1.5rem;
      color: #61dafb;
      text-shadow: 0 0 10px #61dafb, 0 0 25px #007bff;
      animation: glowPulse 3s ease-in-out infinite;
    }

    @keyframes glowPulse {
      0%, 100% { text-shadow: 0 0 10px #61dafb, 0 0 20px #007bff; }
      50% { text-shadow: 0 0 20px #00e5ff, 0 0 40px #61dafb; }
    }

    #chat-box {
      flex: 1;
      padding: 15px 20px;
      overflow-y: auto;
      font-family: "Fira Code", monospace;
    }

    .msg { margin-bottom: 15px; line-height: 1.5; }
    .user { color: #61dafb; font-weight: 600; }
    .ai { color: #fff; white-space: pre-wrap; }

    .input-container {
      display: flex;
      gap: 10px;
      padding: 15px 20px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      outline: none;
    }
    input:focus { box-shadow: 0 0 8px #61dafb; }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #61dafb, #00b3ff);
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(97, 218, 251, 0.25);
      transition: all 0.25s ease-in-out;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 25px rgba(97, 218, 251, 0.5);
    }

    .copy-btn {
      position: sticky;
      top: 10px;
      right: 10px;
      float: right;
      z-index: 5;
    }
    .copy-btn:hover {
      background: #61dafb;
      color: #000;
    }

    .cursor {
      display: inline-block;
      width: 8px;
      height: 1em;
      background-color: #61dafb;
      animation: blink 1s infinite;
      vertical-align: bottom;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      50.01%, 100% { opacity: 0; }
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb {
      background: rgba(97, 218, 251, 0.3);
      border-radius: 10px;
    }

    @media (max-width: 900px) {
      body { flex-direction: column; }
      #preview { height: 40vh; margin: 20px; }
      .chat-panel { max-width: none; width: calc(100% - 40px); margin: 0 20px 20px; }
    }

    pre {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <iframe id="preview"></iframe>

  <div class="chat-panel">
    <header>
      <h1>ğŸ¨ AI CSS Generator</h1>
    </header>

    <div id="chat-box"></div>

    <div class="input-container">
      <input id="query" placeholder="ì˜ˆ: ë„¤ì˜¨ ëŠë‚Œì˜ ì˜ˆìˆ ì ì¸ ë²„íŠ¼ ë§Œë“¤ì–´ì¤˜" />
      <button onclick="sendQuery()">ì „ì†¡</button>
    </div>
  </div>

  <script>
    async function sendQuery() {
      const query = document.getElementById("query").value.trim();
      if (!query) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”!");
      const chatBox = document.getElementById("chat-box");

      // ğŸ§ ì‚¬ìš©ì ë©”ì‹œì§€
      const userMsg = document.createElement("div");
      userMsg.className = "msg user";
      userMsg.innerText = "ğŸ‘¤ " + query;
      chatBox.appendChild(userMsg);

      // ğŸ’¬ GPT ì‘ë‹µ ì»¨í…Œì´ë„ˆ
      const aiMsg = document.createElement("div");
      aiMsg.className = "msg ai";
      chatBox.appendChild(aiMsg);
      chatBox.scrollTop = chatBox.scrollHeight;

      // ğŸ¤– GPT "ìƒê° ì¤‘" í‘œì‹œ
      const typing = document.createElement("div");
      typing.innerHTML = "ğŸ’¬ <span class='dot'>â—</span><span class='dot'>â—</span><span class='dot'>â—</span>";
      typing.classList.add("thinking");
      aiMsg.appendChild(typing);

      // ğŸ”— ì„œë²„ ìš”ì²­
      const res = await fetch("http://127.0.0.1:8000/chat/stream", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, session_id: "designer-session" }),
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder("utf-8");

      let fullText = "";
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        fullText += decoder.decode(value, { stream: true });
      }

      typing.remove();

      // âœ‚ï¸ ì„¤ëª… / ì½”ë“œ ë¶„ë¦¬ ì‹œë„
      const codeMatch = fullText.match(/```(?:html|css)?([\s\S]*?)```/i);
      const explanation = codeMatch
        ? fullText.slice(0, codeMatch.index).trim()
        : "ì¢‹ì•„ìš”! ì•„ë˜ëŠ” ìš”ì²­í•˜ì‹  ë””ìì¸ ì½”ë“œì…ë‹ˆë‹¤. ğŸ˜Š";
      const codeText = codeMatch ? codeMatch[1].trim() : fullText.trim();

      // ğŸ’¬ ì„¤ëª… ë§í’ì„ 
      const explainBox = document.createElement("div");
      explainBox.style.marginBottom = "12px";
      explainBox.innerText = explanation;
      aiMsg.appendChild(explainBox);

      // ğŸ“œ ì½”ë“œ ì˜ì—­ ì»¨í…Œì´ë„ˆ
      const codeContainer = document.createElement("div");
      codeContainer.style.position = "relative";
      codeContainer.style.marginTop = "8px";
      aiMsg.appendChild(codeContainer);

      const pre = document.createElement("pre");
      const codeEl = document.createElement("code");
      codeEl.className = "language-html";
      pre.appendChild(codeEl);
      codeContainer.appendChild(pre);

      // ğŸ“‹ ë³µì‚¬ ë²„íŠ¼ (ê³ ì •)
      const copyBtn = document.createElement("button");
      copyBtn.className = "copy-btn";
      copyBtn.innerText = "ğŸ“‹ ë³µì‚¬";
      copyBtn.style.position = "absolute";
      copyBtn.style.top = "10px";
      copyBtn.style.right = "10px";
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(codeText);
        copyBtn.innerText = "âœ… ë³µì‚¬ë¨!";
        setTimeout(() => (copyBtn.innerText = "ğŸ“‹ ë³µì‚¬"), 2000);
      };
      codeContainer.appendChild(copyBtn);

      // ğŸª„ íƒ€ì´í•‘ íš¨ê³¼
      let i = 0;
      const typingInterval = setInterval(() => {
        if (i < codeText.length) {
          codeEl.textContent += codeText[i];
          chatBox.scrollTop = chatBox.scrollHeight;
          i++;
        } else {
          clearInterval(typingInterval);

          // ğŸ¨ ì½”ë“œ í•˜ì´ë¼ì´íŠ¸ (ì™„ì„± í›„ ì ìš©)
          hljs.highlightElement(codeEl);

          // ğŸ§  ì™„ì„± í›„ ë¯¸ë¦¬ë³´ê¸° ë Œë”
          const htmlMatch = codeText.match(/<html[\s\S]*?<\/html>/im);
          if (htmlMatch) {
            const htmlCode = htmlMatch[0].replace(/<title>.*?<\/title>/i, "");
            const preview = document.getElementById("preview");
            const doc = preview.contentDocument || preview.contentWindow.document;
            doc.open();
            doc.write(htmlCode);
            doc.close();
          }
        }
      }, 10); // 10ms per char

      document.getElementById("query").value = "";
    }

    // ğŸï¸ GPT íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€
    const style = document.createElement("style");
    style.textContent = `
    .thinking {
      color: #61dafb;
      font-weight: 500;
      margin-bottom: 10px;
    }
    .dot {
      display: inline-block;
      opacity: 0.2;
      animation: typingDots 1s infinite;
    }
    .dot:nth-child(1) { animation-delay: 0s; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingDots {
      0%, 20% {opacity: 0.2;}
      50% {opacity: 1;}
      100% {opacity: 0.2;}
    }
    `;
    document.head.appendChild(style);
  </script>

</body>
</html>
